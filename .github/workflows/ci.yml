name: github-actions-test ci
on:
  pull_request:
    types: [ready_for_review]
  push: 
  workflow_dispatch:

jobs:
  test:
    name: Checkout the E2E Repository and Run tests
    runs-on: ubuntu-latest
    steps:

      - name: Suppress Runner Error
        run: |
          git config --global init.defaultBranch main

      - name: Checkout Main Repo
        uses: actions/checkout@v2
        with:
          ref: chore/sc-7778/if-a-test-fails-in-the-e2e-repo-it-gets-reflected  

      - name: Check out E2E Repo and Run E2E Tests
        uses: actions/checkout@v2
        with:
          repository: theartofeducation/aoeu-e2e
          ref: main
          ssh-strict: false
          # The ACCESS.TOKEN needs to be added to this repository also
          token: ${{ secrets.ACCESS_TOKEN }}
          persist-credentials: false
          path: ./ci.yml

      - name: Install dependencies
      run: yarn install

      - name: Run Lint
        run: yarn lint

      - name: Run Prettier
        run: yarn prettier --check .

      - name: Set-Up Node
        uses: actions/setup-node@v2
        with:
          node-version: "14.x"

      - name: Install and Run Cypress API Tests
        uses: cypress-io/github-action@v2
        with:
          install: true
          start: yarn run test:api
        env:
          CYPRESS_API_BASE_URL: ${{ secrets.API_BASE_URL }}
          CYPRESS_PRODUCT_SERVICE_BASE_URL: ${{ secrets.PRODUCT_SERVICE_BASE_URL}}
          CYPRESS_PRODUCT_SERVICE_USERNAME: ${{ secrets.PRODUCT_SERVICE_USERNAME}}
          CYPRESS_PRODUCT_SERVICE_PASSWORD: ${{ secrets.PRODUCT_SERVICE_PASSWORD}}
          CYPRESS_EMAIL: ${{ secrets.EMAIL }}
          CYPRESS_PASSWORD: ${{ secrets.PASSWORD }}
          CYPRESS_BASIC_AUTH_USERNAME: ${{ secrets.BASIC_AUTH_USERNAME }}
          CYPRESS_BASIC_AUTH_PASSWORD: ${{ secrets.BASIC_AUTH_PASSWORD }}
          CYPRESS_QA_USER_ID: ${{ secrets.QA_USER_ID}}
         ##git clone --single-branch --no-tags --depth 1 -b master https://@github.com/theartofeducation/aoeu.e2e ./.github/actions/ci.yml


